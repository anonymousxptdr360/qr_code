<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suite QR : Générateur & Scanner Ultimate</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Librairies QR (Générateur & Scanner) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- STYLE GLOBAL & CUSTOM --- */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            overflow: hidden; /* Empêche le scroll global, on gère par panneau */
        }

        /* Layout Principal */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }
        }

        /* --- COLONNE GAUCHE : GÉNÉRATEUR --- */
        .generator-panel {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #e5e7eb;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .generator-panel {
                flex: 0 0 450px; /* Largeur fixe sur desktop */
                border-right: 1px solid #e5e7eb;
                border-bottom: none;
                z-index: 10;
                box-shadow: 4px 0 24px rgba(0,0,0,0.05);
            }
        }

        /* --- COLONNE DROITE : SCANNER --- */
        .scanner-panel {
            flex: 1;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* Onglets Scanner */
        .scanner-tabs {
            display: flex;
            background: white;
            padding: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 20;
        }
        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: #eff6ff;
            color: #2563eb;
        }

        /* Zone Caméra / Fichier */
        .scanner-viewport {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
        }

        /* Fix Caméra Plein Écran */
        #reader {
            width: 100%;
            height: 100%;
            position: relative;
        }
        #reader video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* Zone Drop Fichier */
        .file-drop-zone {
            width: 100%;
            height: 100%;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px dashed #cbd5e1;
            margin: 1rem;
            border-radius: 1rem;
            color: #64748b;
            transition: all 0.3s;
        }
        .file-drop-zone.dragover {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        /* --- RÉSULTAT SCAN (Flottant) --- */
        .scan-result-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 50;
        }
        .scan-result-overlay.visible {
            transform: translateY(0);
        }

        /* --- QR DISPLAY --- */
        #qrcode-display canvas, #qrcode-display img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            image-rendering: pixelated; /* Netteté */
        }

        /* --- FULLSCREEN OVERLAY --- */
        #fs-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        #fs-overlay img {
            width: 90vw;
            height: 90vh;
            object-fit: contain;
            image-rendering: pixelated;
        }

    </style>
</head>
<body>

<div class="app-container">
    
    <!-- ========================================== -->
    <!-- PANNEAU GAUCHE : GÉNÉRATEUR -->
    <!-- ========================================== -->
    <div class="generator-panel p-6">
        <header class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-qrcode text-blue-600"></i> Suite QR <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Ultimate</span>
            </h1>
            <p class="text-sm text-gray-500 mt-1">Générateur haute densité & Scanner universel</p>
        </header>

        <!-- Zone Input -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Contenu à encoder</label>
            <textarea id="textInput" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition resize-none" placeholder="URL, Texte, Wi-Fi..."></textarea>
            <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                <span id="charCount">0 caractères</span>
                <button id="clearBtn" class="text-red-500 hover:text-red-700 font-medium hover:underline">Effacer</button>
            </div>
        </div>

        <!-- Zone QR Affichage -->
        <div class="flex-1 flex flex-col items-center justify-center min-h-[200px] bg-gray-50 rounded-xl border border-dashed border-gray-300 mb-6 relative group" id="qrcode-container">
            <div id="qrcode-display" class="p-2 bg-white rounded-lg shadow-sm">
                <!-- Le QR code sera injecté ici -->
                <div class="text-gray-400 text-center p-4">
                    <i class="fa-regular fa-image text-3xl mb-2"></i><br>Le QR apparaîtra ici
                </div>
            </div>
            
            <!-- Bouton Fullscreen (visible au survol/génération) -->
            <button id="expandBtn" class="hidden absolute top-2 right-2 bg-gray-800 text-white p-2 rounded-lg shadow-lg hover:bg-black transition">
                <i class="fa-solid fa-expand"></i>
            </button>
        </div>

        <!-- Boutons d'action -->
        <div class="grid grid-cols-3 gap-3 mb-6">
            <button onclick="downloadQR('png')" class="flex items-center justify-center gap-2 py-2 px-4 bg-white border border-gray-200 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700 transition shadow-sm">
                <i class="fa-regular fa-file-image"></i> PNG
            </button>
            <button onclick="downloadQR('jpeg')" class="flex items-center justify-center gap-2 py-2 px-4 bg-white border border-gray-200 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700 transition shadow-sm">
                <i class="fa-regular fa-file-image"></i> JPG
            </button>
            <button onclick="downloadQR('pdf')" class="flex items-center justify-center gap-2 py-2 px-4 bg-white border border-gray-200 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700 transition shadow-sm">
                <i class="fa-regular fa-file-pdf"></i> PDF
            </button>
        </div>
        
        <!-- Historique supprimé -->
    </div>

    <!-- ========================================== -->
    <!-- PANNEAU DROITE : SCANNER -->
    <!-- ========================================== -->
    <div class="scanner-panel">
        
        <!-- Onglets (Ordre inversé : Fichier d'abord) -->
        <div class="scanner-tabs">
            <div class="tab-btn active" onclick="setScannerMode('file')" id="tab-file">
                <i class="fa-solid fa-file-import mr-2"></i>Fichier
            </div>
            <div class="tab-btn" onclick="setScannerMode('camera')" id="tab-camera">
                <i class="fa-solid fa-camera mr-2"></i>Caméra
            </div>
        </div>

        <!-- Viewport Scanner -->
        <div class="scanner-viewport">
            
            <!-- Mode Caméra -->
            <div id="camera-view" class="w-full h-full relative hidden">
                <div id="reader"></div>
                <!-- PAS D'OVERLAY VISUEL RESTRICTIF ICI -->
                
                <!-- Message Permission -->
                <div id="camera-permission-msg" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 text-white p-6 text-center hidden z-50">
                    <i class="fa-solid fa-video-slash text-4xl mb-4 text-gray-500"></i>
                    <h3 class="font-bold text-lg mb-2">Caméra inactive</h3>
                    <p class="text-sm text-gray-400 mb-4">Veuillez autoriser l'accès à la caméra pour scanner.</p>
                    <button onclick="startCamera()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-medium transition">Activer la caméra</button>
                </div>
            </div>

            <!-- Mode Fichier (Visible par défaut) -->
            <div id="file-view" class="w-full h-full p-4">
                <div class="file-drop-zone" id="dropZone">
                    <i class="fa-solid fa-cloud-arrow-up text-5xl mb-4 text-blue-200"></i>
                    <p class="font-medium text-lg">Glissez une image ici</p>
                    <p class="text-sm mt-1 mb-4">ou collez avec Ctrl+V</p>
                    <button onclick="document.getElementById('fileInput').click()" class="bg-white border border-gray-300 text-gray-700 px-6 py-2 rounded-full font-medium hover:bg-gray-50 transition shadow-sm">
                        Choisir un fichier
                    </button>
                    <input type="file" id="fileInput" accept="image/*" hidden>
                </div>
            </div>

        </div>

        <!-- Résultat Overlay -->
        <div id="resultOverlay" class="scan-result-overlay">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <span class="font-bold text-gray-800">QR Détecté</span>
                </div>
                <button onclick="closeResult()" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4 break-all max-h-32 overflow-y-auto font-mono text-sm text-gray-700" id="scanContent">
                ...
            </div>

            <div class="grid grid-cols-2 gap-3" id="actionButtons">
                <!-- Boutons injectés dynamiquement -->
            </div>
        </div>

    </div>
</div>

<!-- Overlay Plein Écran pour Générateur -->
<div id="fs-overlay" onclick="this.style.display='none'">
    <img id="fs-img" src="" alt="Full Screen QR">
</div>

<!-- Notification Toast -->
<div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm font-medium opacity-0 transition-opacity pointer-events-none z-[10000]">
    Message ici
</div>

<script>
    /**
     * ====================================================================
     * LOGIQUE GÉNÉRATEUR
     * ====================================================================
     */
    const textInput = document.getElementById('textInput');
    const qrDisplay = document.getElementById('qrcode-display');
    const charCount = document.getElementById('charCount');
    const expandBtn = document.getElementById('expandBtn');
    
    let qrInstance = null;

    textInput.addEventListener('input', () => {
        const text = textInput.value;
        charCount.textContent = `${text.length} caractères`;
        generate(text);
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
        textInput.value = '';
        charCount.textContent = '0 caractères';
        generate('');
    });

    function generate(text) {
        if (!text.trim()) {
            qrDisplay.innerHTML = `<div class="text-gray-400 text-center p-4"><i class="fa-regular fa-image text-3xl mb-2"></i><br>Le QR apparaîtra ici</div>`;
            expandBtn.classList.add('hidden');
            return;
        }

        try {
            // Utilisation de TypeNumber 0 (Auto) et Correction 'L' pour max capacité
            const typeNumber = 0;
            const errorCorrectionLevel = 'L';
            const qr = qrcode(typeNumber, errorCorrectionLevel);
            
            // Support UTF-8 robuste
            qr.addData(text);
            qr.make();
            
            // Création de l'image
            const imgHtml = qr.createImgTag(6, 4); // Cell size 6, Margin 4
            qrDisplay.innerHTML = imgHtml;
            
            // Ajout style Tailwind aux images générées
            const img = qrDisplay.querySelector('img');
            if(img) {
                img.style.maxWidth = "100%";
                img.style.height = "auto";
                img.style.borderRadius = "8px";
            }

            expandBtn.classList.remove('hidden');

            // Setup Fullscreen
            expandBtn.onclick = () => {
                document.getElementById('fs-img').src = img.src;
                document.getElementById('fs-overlay').style.display = 'flex';
            };

        } catch (e) {
            console.error(e);
            qrDisplay.innerHTML = `<p class="text-red-500 text-sm text-center">Texte trop long pour ce format !</p>`;
        }
    }

    // Téléchargement
    window.downloadQR = (fmt) => {
        const img = qrDisplay.querySelector('img');
        if (!img) return showToast('Rien à télécharger');

        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        if (fmt === 'pdf') {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            // Centrer sur A4
            const imgProps = pdf.getImageProperties(canvas.toDataURL('image/png'));
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 10, pdfWidth, pdfHeight);
            pdf.save('qrcode.pdf');
        } else {
            const link = document.createElement('a');
            link.download = `qrcode.${fmt}`;
            link.href = canvas.toDataURL(`image/${fmt}`);
            link.click();
        }
        showToast(`Téléchargé en ${fmt.toUpperCase()}`);
    };

    /**
     * ====================================================================
     * LOGIQUE SCANNER (ULTIMATE FIX - FULL FIELD OF VIEW)
     * ====================================================================
     */
    let html5QrCode;
    let isScanning = false;
    let currentMode = 'file'; // DÉFAUT : FICHIER

    function setScannerMode(mode) {
        currentMode = mode;
        // UI
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${mode}`).classList.add('active');
        
        document.getElementById('camera-view').classList.toggle('hidden', mode !== 'camera');
        document.getElementById('file-view').classList.toggle('hidden', mode !== 'file');

        if (mode === 'camera') {
            startCamera();
        } else {
            stopCamera();
        }
    }

    async function startCamera() {
        document.getElementById('camera-permission-msg').classList.add('hidden');
        if (isScanning) return; // Déjà actif

        // Nettoyage préalable
        if(html5QrCode) {
            try { await html5QrCode.stop(); } catch(e){}
        }

        html5QrCode = new Html5Qrcode("reader");
        
        // CONFIGURATION POUR SCAN PLEIN ÉCRAN
        // On ne définit PAS de petite qrbox statique.
        // On demande à scanner presque tout le viewfinder.
        const config = { 
            fps: 15, // Un peu plus rapide
            qrbox: function(viewfinderWidth, viewfinderHeight) {
                // On scanne 90% de la surface disponible
                // Cela simule le comportement "Full Field of View"
                return {
                    width: Math.floor(viewfinderWidth * 0.90),
                    height: Math.floor(viewfinderHeight * 0.90)
                };
            }
        };
        
        try {
            await html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess, 
                (errorMessage) => { /* ignore frame errors */ }
            );
            isScanning = true;
        } catch (err) {
            console.error("Erreur Caméra", err);
            document.getElementById('camera-permission-msg').classList.remove('hidden');
            isScanning = false;
        }
    }

    async function stopCamera() {
        if (html5QrCode && isScanning) {
            try { await html5QrCode.stop(); } catch(e) {}
            html5QrCode.clear();
            isScanning = false;
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        // Nettoyage des données (fix pour certains scanners qui renvoient du JSON)
        let cleanText = decodedText;
        if(decodedText.trim().startsWith('{') && decodedText.trim().endsWith('}')) {
            try {
                const parsed = JSON.parse(decodedText);
                if(parsed.text) cleanText = parsed.text;
                else if(parsed.url) cleanText = parsed.url;
            } catch(e) {}
        }
        
        showResult(cleanText);
    }

    // Gestion Upload Fichier & Drag n Drop
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
    });

    dropZone.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]));
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
    
    // Support Coller (Paste)
    document.addEventListener('paste', (e) => {
        if (currentMode !== 'file') return;
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.kind === 'file') {
                handleFile(item.getAsFile());
            }
        }
    });

    function handleFile(file) {
        if(!file) return;
        
        // Méthode 1: html5-qrcode (rapide)
        const tempScanner = new Html5Qrcode("reader");
        tempScanner.scanFile(file, true)
            .then(decodedText => onScanSuccess(decodedText))
            .catch(err => {
                console.log("Fallback jsQR car html5-qrcode a échoué:", err);
                // Méthode 2: Fallback jsQR (robuste)
                scanWithJsQR(file);
            });
    }

    function scanWithJsQR(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, canvas.width, canvas.height);
                if (code) onScanSuccess(code.data);
                else showToast("Aucun QR code détecté");
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    /**
     * ====================================================================
     * INTERFACE RÉSULTAT
     * ====================================================================
     */
    function showResult(text) {
        const overlay = document.getElementById('resultOverlay');
        const content = document.getElementById('scanContent');
        const btns = document.getElementById('actionButtons');
        
        content.textContent = text;
        
        const isUrl = /^(http|https):\/\/[^ "]+$/.test(text);
        
        let btnHtml = `
            <button onclick="copyToClipboard('${text.replace(/'/g, "\\'")}')" class="col-span-${isUrl ? '1' : '2'} bg-white border border-gray-300 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-50">
                <i class="fa-regular fa-copy mr-2"></i>Copier
            </button>
        `;
        
        if(isUrl) {
            btnHtml += `
                <button onclick="window.open('${text}', '_blank')" class="bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">
                    <i class="fa-solid fa-external-link-alt mr-2"></i>Ouvrir
                </button>
            `;
        }
        
        btns.innerHTML = btnHtml;
        overlay.classList.add('visible');
    }

    function closeResult() {
        document.getElementById('resultOverlay').classList.remove('visible');
    }

    function copyToClipboard(text) {
        // Fallback pour iframe/mobile
        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        showToast("Copié !");
    }

    // Utilitaires
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.opacity = '1';
        setTimeout(() => toast.style.opacity = '0', 3000);
    }

    // Init - Démarrage en mode fichier par défaut, pas d'historique
    window.addEventListener('load', () => {
        // Rien de spécial au chargement, mode fichier est le HTML par défaut
    });

</script>

</body>
</html>
